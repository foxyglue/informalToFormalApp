########################################
# BASE IMAGE
########################################
FROM python:3.10-slim

########################################
# ENVIRONMENT SETUP
########################################
ENV PYTHONUNBUFFERED=1
ENV NODE_VERSION=18.x

WORKDIR /app

########################################
# INSTALL SYSTEM DEPENDENCIES
########################################
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

########################################
# INSTALL NODE.JS
########################################
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION} | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

########################################
# INSTALL PYTHON DEPENDENCIES
########################################
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

########################################
# BUILD FRONTEND
########################################
# Copy frontend files
COPY frontend/package*.json ./frontend/
WORKDIR /app/frontend
RUN npm ci --only=production

# Copy frontend source and build
COPY frontend/ ./
RUN npm run build

# Move build to accessible location
RUN mv dist /app/frontend_build

########################################
# COPY BACKEND FILES
########################################
WORKDIR /app
COPY app.py .

########################################
# CLEANUP (Optional - reduces image size)
########################################
RUN apt-get purge -y --auto-remove nodejs \
    && rm -rf /app/frontend \
    && rm -rf /root/.npm

########################################
# EXPOSE PORT
########################################
EXPOSE 7860

########################################
# START APPLICATION
########################################
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "7860"]